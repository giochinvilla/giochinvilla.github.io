<!DOCTYPE html>
<html lang="it">
<head>

<meta name="description" content="Esplora il mondo avvincente dei giochi da tavolo, Warhammer e giochi di ruolo sul 
nostro sito. Scopri guide, risorse e comunità appassionate per arricchire la tua esperienza ludica. 
Unisciti a noi nel coltivare la passione per l'immaginazione e la strategia, dove ogni dado lanciato porta avventure senza fine. 
Entra nel nostro regno virtuale dedicato agli appassionati di giochi, dove l'unico scopo è condividere la gioia del gioco!.">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YXSNQ75QND"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-YXSNQ75QND');
  </script>

  <title>Giochi in Villa</title>
 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <link rel="stylesheet" href="../../generalCSS.css">
  <link rel="stylesheet" href="../../fonts/fonts.css">
  <link rel="stylesheet" href="../../buttons.css">
  
  <link rel="icon" type="image/x-icon" href="../../images/icons/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <meta charset="utf-8">
  
</head>
<body>
  
  <div class="container-fluid text-center bg-gradient bg-red2 p-2">
	<div class="circle mx-auto">
	  <div><img src='../../images/icons/logo.webp' width="75%"></img></div>
	  <div class="rotatinglogo text-light" style="font-family: 'Typewriter';">
	    <div>Giochi in Villa • Giochi in Villa •</div>
      </div>
    </div>
  </div>
  
  <div class="sticky-top" loadHTML="../../template_containers/nav.html"></div>
  
  <div class="row m-auto">
    <div class="col-xl-9 ps-xl-5 p-3">

	  <div class="container-fluid p-md-5 p-3 border bg-white shadow">
		<h3>
		  <img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img>
		  <span class='badge bg-danger rounded-pill text-white'>ISCRIZIONE</span>
		  <span> Giochi di Ruolo - Sala Comics 2024<span>
		</h3>
		<hr>

		<form class="g-2 needs-validation" id="inputForm" novalidate>
			<div class="accordion shadow">
				<div class="accordion-item">
					<div class="accordion-header">
						<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#dati" aria-expanded="true" aria-controls="anagrafica_partecipante">
							<h4>Iscrizione</h4>
						</button>
					</div>
					
					<div id="dati" class="accordion-collapse collapse show">
						<div class="accordion-body row">
							<div class="col-md-6 mb-2">
								<div class="form-floating">
									<input id="user_name" name="user_name" class="form-control" placeholder="" required>
									<label class="form-label">Nome*</label><div class="invalid-feedback">Inserisci un nome</div>
								</div>
							</div>
							
							<div class="col-md-6 mb-2">
								<div class="form-floating">
									<input id="user_surname" name="user_surname" class="form-control" placeholder="" required>
									<label class="form-label">Cognome*</label><div class="invalid-feedback">Inserisci un cognome</div>
								</div>
							</div>
							
							<div class="col-md-4 mb-2">
								<div class="form-floating">
									<input id="email" name="email" class="form-control" placeholder="" required>
									<label class="form-label">Email*</label><div class="invalid-feedback">Inserisci un indirizzo email</div>
								</div>
							</div>

							<div class="col-md-4 mb-2">
								<div class="form-floating">
									<select id="campaign_ID" name="campaign_ID" class="form-select" required>
										<option value="" disabled selected>Seleziona una partita*</option>
									</select>
									<label for="campaign_ID" class="form-label">Partita*</label>
									<div class="invalid-feedback">Seleziona una partita</div>
								</div>
							</div>
							
							<div class="col-md-4 mb-2">
								<div class="form-floating">
									<select id="time_slot" name="time_slot" class="form-select" required>
										<option value="" disabled selected>Seleziona uno slot orario*</option>
									</select>
									<label for="time_slot" class="form-label">Slot orario*</label>
									<div class="invalid-feedback">Seleziona uno slot orario</div>
								</div>
							</div>
							
							<br><br><br>
							<h5 id="residui">Seleziona una partita</h5>
							<hr>
							<br>
							<div id="gioco"></div>
							<br><br>
							<div id="descrizione"></div>
						</div>
					</div>
				</div>  
			</div>

			<br>
			<hr>
			<div class="mt-4">
				<input type="checkbox" id="gdpr" class="form-check-input" required>
				<label for="gdpr" class="form-check-label">Dichiaro di accettare i termini e le condizioni del trattamento dei dati conformemente alla normativa europea in materia di protezione dei dati (GDPR).</label>
				<div class="invalid-feedback">Devi accettare per poterti iscrivere</div>
			</div>
			<br>
			<button id="submit" type="submit" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#sendingModal" disabled>Invia l'iscrizione</button>
		</form>
	</div>
  </div>


	<div class="modal fade" id="sendingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<h1 class="modal-title fs-5" id="sendingModalLabel"><img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img>
				<span class='badge bg-danger rounded-pill text-white'>CARICAMENTO</span> Invio dell'iscrizione
			</h1>
		  </div>
		  <div id="modalText" class="p-3">
			<div class="modal-body d-flex justify-content-center">
			  <div class="spinner-border" role="status">
				<span class="visually-hidden">Caricamento...</span>
			  </div>
			</div>
		  </div>
		  <div class="modal-footer" id="modal-footer">
			<a href='#' class='btn btn-primary text-white' role='button'>Esci</a>
		  </div>
		</div>
	  </div>
	</div>
	
	<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="loadingModalLabel">
						<img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img>
						<span class='badge bg-danger rounded-pill text-white'>CARICAMENTO</span> Recupero dei dati in corso
					</h1>
				</div>
				<div class="modal-body d-flex justify-content-center">
					<div class="spinner-border" role="status">
						<span class="visually-hidden">Caricamento...</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	 
	 
    <div class="col-xl-3 pe-xl-5 p-3">  
		<div loadHTML="../../template_containers/social.html"></div>
    </div>
  </div>
  
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark text-secondary">
    <div class="ps-3">
		Powered by Github - Made by Vice<br>
	</div>
  </nav>

<script>

  loadExternalHTML();
  
  const text = document.querySelector(".rotatinglogo");
	text.innerHTML = text.innerText
	.split("")
	.map(
	   (char, i) => `<span style="transform:rotate(${i * 10.3}deg)">${char}</span>`
	).join("");
		
  document.addEventListener("DOMContentLoaded", function() {
    var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), {
      backdrop: 'static',
      keyboard: false
    });
    loadingModal.show();

    fetch("https://script.google.com/macros/s/AKfycbwy6ucZYjYYJAzC5GxxoQBi3-f9xXl75LtR_erNjfbGnJUXMby_JFmibfumGqa_Z7DGVA/exec", {
      method: "GET",
      redirect: "follow",
      headers: {
        "Content-Type": "text/plain;charset=utf-8"
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
    return response.json();
    })
    .then(data => {
      const campaignSelect = document.getElementById("campaign_ID");
      const timeSlotSelect = document.getElementById("time_slot");
      const giocoDiv = document.getElementById("gioco");
      const descrizioneDiv = document.getElementById("descrizione");
      const residuiDiv = document.getElementById("residui");

      campaignSelect.innerHTML = '<option value="" disabled selected>Seleziona una partita*</option>';
      timeSlotSelect.innerHTML = '<option value="" disabled selected>Seleziona uno slot orario*</option>';
      giocoDiv.textContent = '';
      descrizioneDiv.textContent = '';
      residuiDiv.textContent = 'Seleziona una partita';

      loadingModal.hide();
        
      if (!Array.isArray(data) || data.length === 0) {
        console.error("Invalid data format:", data);
        return;
      }

      data.forEach(item => {
        const option = document.createElement("option");
        option.value = item.campaign_name; 
        option.textContent = item.campaign_name; 
        campaignSelect.appendChild(option);
      });

      campaignSelect.addEventListener("change", function() {
        const selectedCampaign = this.value;
        timeSlotSelect.innerHTML = '<option value="" disabled selected>Seleziona uno slot orario*</option>';
        giocoDiv.textContent = '';
        descrizioneDiv.textContent = '';
        residuiDiv.textContent = 'Seleziona uno slot orario';

        populateTimeSlots(selectedCampaign, data);
        populateGameAndDescription(selectedCampaign, data);
      });

      timeSlotSelect.addEventListener("change", function() {
        const selectedCampaign = campaignSelect.value;
        const selectedTimeSlot = this.value;
		
        populateResidual(selectedCampaign, selectedTimeSlot, data);
      });
    })
    .catch(error => console.error("Error fetching data:", error));
  });

  function populateTimeSlots(selectedCampaign, data) {
    const timeSlotSelect = document.getElementById("time_slot");
    timeSlotSelect.innerHTML = '<option value="" disabled selected>Seleziona uno slot orario*</option>';

    data.forEach(item => {
      if (item.campaign_name === selectedCampaign) {
        console.log("Found campaign for time slots:", item.campaign_name);
            
        const residual = item.residual; 
        const timeSlots = item.time_slots;

        if (Array.isArray(residual) && Array.isArray(timeSlots) && residual.length === timeSlots.length) {
          residual.forEach((res, index) => {
            if (res !== -1 && timeSlots[index] !== undefined) {
              const option = document.createElement("option");
              option.value = timeSlots[index]; 
              option.textContent = timeSlots[index];
              timeSlotSelect.appendChild(option);
            }
          });
        } else {
                console.error("Lengths do not match or arrays are undefined.");
            }
        }
    });
  }

  function populateGameAndDescription(selectedCampaign, data) {
    const giocoDiv = document.getElementById("gioco");
    const descrizioneDiv = document.getElementById("descrizione");
    const selectedCampaignData = data.find(item => item.campaign_name === selectedCampaign);

    if (selectedCampaignData) {
      giocoDiv.textContent = 'Gioco: ' + (selectedCampaignData.game || 'Gioco non disponibile');
      descrizioneDiv.textContent = 'Descrizione: ' + (selectedCampaignData.description || 'Descrizione non disponibile');
    } else {
      console.error("Selected campaign not found in data.");
    }
  }

  function populateResidual(selectedCampaign, selectedTimeSlot, data) {
    const residuiDiv = document.getElementById("residui");
    const submitButton = document.getElementById("submit");
    const selectedCampaignData = data.find(item => item.campaign_name === selectedCampaign);

    if (selectedCampaignData) {
      const timeSlots = selectedCampaignData.time_slots;
      const residual = selectedCampaignData.residual;
      const timeSlotIndex = timeSlots.indexOf(selectedTimeSlot);

      if (timeSlotIndex !== -1 && residual[timeSlotIndex] !== undefined) {
        if (residual[timeSlotIndex] > 0) {
          residuiDiv.textContent = `Sono rimasti ${residual[timeSlotIndex]} posti disponibili ✔️`;
          submitButton.disabled = false; 
        } else {
          residuiDiv.textContent = 'Posti Esauriti ❌';
          submitButton.disabled = true;
          }
        } else {
          residuiDiv.textContent = 'Dati non disponibili';
          submitButton.disabled = true;
        }
    } else {
      residuiDiv.textContent = 'Nessuna campagna trovata';
      console.error("Selected campaign not found in data.");
      submitButton.disabled = true;
    }
  }

  document.getElementById('inputForm').addEventListener('submit', function(event) { 
    if (!this.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
      this.classList.add('was-validated');
      document.getElementById("sendingModalLabel").innerHTML = "<img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img> <span class='badge bg-danger rounded-pill text-white'>ATTENZIONE</span> Campi non compilati"
	  document.getElementById("modalText").innerHTML = "<i class='fa fa-exclamation-triangle'></i> Completa tutti i dati necessari prima di inviare!";
      document.getElementById("modal-footer").innerHTML = "<button type='button' class='btn btn-primary' data-bs-dismiss='modal'>Esci</button>";
      return;
    }

	document.getElementById("sendingModalLabel").innerHTML = "<img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img><span class='badge bg-danger rounded-pill text-white'>CARICAMENTO</span> Invio dell'iscrizione"
	document.getElementById("modalText").innerHTML = "<div class='modal-body d-flex justify-content-center'><div class='spinner-border' role='status'><span class='visually-hidden'>Caricamento...</span></div></div>"
    document.getElementById("modal-footer").innerHTML = "";
    event.preventDefault(); 
    var formData = new FormData(this); 
	
	formData.append("requestType", "request");
    formData.append("campaign_ID", document.getElementById("campaign_ID").selectedIndex);
	formData.append("time_slot", document.getElementById("time_slot").selectedIndex);

    fetch('https://script.google.com/macros/s/AKfycbwy6ucZYjYYJAzC5GxxoQBi3-f9xXl75LtR_erNjfbGnJUXMby_JFmibfumGqa_Z7DGVA/exec', { 
	  method: 'POST', 
	  body: formData 
	}) 
	.then(response => response.text())
	.then(text => {
		if (text === 'Errore! Valore non valido rilevato. Contatta tecnico.giochinvilla@gmail.com') {
				document.getElementById("sendingModalLabel").innerHTML = "<img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img><span class='badge bg-danger rounded-pill text-white'>ERRORE</span> Rilevati dati invalidi"
				document.getElementById("modalText").innerHTML = "<i class='fa fa-exclamation-triangle'></i> Valore non valido rilevato. Contatta tecnico.giochinvilla@gmail.com"
				document.getElementById("modal-footer").innerHTML = "<a href='../../index.html' class='btn btn-primary text-white' role='button'>Esci</a>";
		} else if (text === 'Mi dispiace! Qualcuno ti ha soffiato l ultimo posto rimasto e quindi non abbiamo potuto prenotarti!') {
				document.getElementById("sendingModalLabel").innerHTML = "<img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img><span class='badge bg-danger rounded-pill text-white'>ATTENZIONE</span> Posti Finiti"
				document.getElementById("modalText").innerHTML = "<i class='fa fa-exclamation-triangle'></i> Mi dispiace! Qualcuno ti ha soffiato l'ultimo posto rimasto e quindi non abbiamo potuto prenotarti!"
				document.getElementById("modal-footer").innerHTML = "<a href='../../index.html' class='btn btn-primary text-white' role='button'>Esci</a>";
		} else {
				document.getElementById("sendingModalLabel").innerHTML = "<img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img><span class='badge bg-danger rounded-pill text-white'>CONGRATULAZIONI</span> Iscrizione completata con successo!"
				document.getElementById("modalText").innerHTML = "A breve ti arriverà una mail che ti confermerà la prenotazione effettuata!"
				document.getElementById("modal-footer").innerHTML = "<a href='../../index.html' class='btn btn-primary text-white' role='button'>Esci</a>";
			}
		})
		.catch(error => { 
			console.error('Error:', error); 
			document.getElementById("sendingModalLabel").innerHTML = "<img alt='Immagine' src='../../images/icons/subtitle-logo.webp' style='width:28px; margin-right: 10px;'></img><span class='badge bg-danger rounded-pill text-white'>ERRORE</span> Rilevati dati invalidi"
			document.getElementById("modalText").innerHTML = "<i class='fa fa-exclamation-triangle'></i> Valore non valido rilevato. Contatta tecnico.giochinvilla@gmail.com"
			document.getElementById("modal-footer").innerHTML = "<a href='../../index.html' class='btn btn-primary text-white' role='button'>Esci</a>";
		});
    }); 

    (() => {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()
	
	
	
  function loadExternalHTML() {
	var z, i, elmnt, file, xhttp;
	z = document.getElementsByTagName("*");
	for (i = 0; i < z.length; i++) {
	  elmnt = z[i];
	  file = elmnt.getAttribute("loadHTML");
	  if (file) {
		xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
		  if (this.readyState == 4) {
		  if (this.status == 200) {elmnt.innerHTML = this.responseText;}
		  if (this.status == 404) {elmnt.innerHTML = "";}
		  elmnt.removeAttribute("loadHTML");
		  loadExternalHTML();
		}
	  }      
	  xhttp.open("GET", file, true);
	  xhttp.send();
			return;
			}
		}
	};
</script>

</body>
</html>